apiVersion: apps/v1
kind: Deployment
metadata:
  name: mastodon-streaming
  namespace: "{{ .Release.Namespace }}"
  labels:
    app.kubernetes.io/name: mastodon
    helm.sh/chart: mastodon-0.1.2
    app.kubernetes.io/instance: mastodon
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/part-of: mastodon
    app.kubernetes.io/component: streaming
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: mastodon
      app.kubernetes.io/instance: mastodon
      app.kubernetes.io/component: streaming
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mastodon
        helm.sh/chart: mastodon-0.1.2
        app.kubernetes.io/instance: mastodon
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/component: streaming
    spec:
      serviceAccountName: mastodon
      
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/name: mastodon
                    app.kubernetes.io/instance: mastodon
                    app.kubernetes.io/component: streaming
                topologyKey: kubernetes.io/hostname
              weight: 1
      securityContext:
        # LinuxServer.io image requires root permissions
        # fsGroup: 1001
        # fsGroupChangePolicy: Always
        supplementalGroups: []
        sysctls: []
      initContainers:
        - name: wait-for-db
          image: "docker.io/beclab/wait-for:0.1.0"
          args:
            - '-it'
            - >-
              {{ .Values.postgres.host }}:{{ .Values.postgres.port }}
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: IfNotPresent
        - name: wait-for-web
          image: "docker.io/beclab/wait-for:0.1.0"
          args:
            - '-it'
            - >-
              mastodon-web:80
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          imagePullPolicy: IfNotPresent
      containers:
        - name: mastodon
          image: "docker.io/beclab/linuxserver-mastodon:4.5.3"
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 1500m
              memory: 2Gi
          securityContext:
            # LinuxServer.io image requires root permissions to write to certain directories
            allowPrivilegeEscalation: true
            # capabilities:
            #   drop:
            #   - ALL
            privileged: false
            readOnlyRootFilesystem: false
            runAsGroup: 0
            runAsNonRoot: false
            runAsUser: 0
            seLinuxOptions: {}
            seccompProfile:
              type: RuntimeDefault
          # LinuxServer.io image requires direct startup command to run streaming service
          # Mastodon streaming uses Puma to start streaming API, listening on port 8080
          # Note: If config file already specifies port, don't repeat it in command line
          command:
            - /bin/bash
            - -ec
            - |
              cd /app/www
              # Completely disable Rails Host Authorization (streaming is internal service, no host verification needed)
              # Method 1: Disable via environment variable
              export RAILS_HOST=""
              # Method 2: Create initializer file to disable Host Authorization
              mkdir -p config/initializers
              cat > config/initializers/disable_host_authorization.rb << 'EOF'
              # Disable Host Authorization middleware
              Rails.application.config.hosts.clear if Rails.application.config.respond_to?(:hosts)
              Rails.application.config.hosts = nil if Rails.application.config.respond_to?(:hosts=)
              
              # Rails 8.0+ disable Host Authorization
              if Rails.application.config.respond_to?(:action_dispatch)
                Rails.application.config.action_dispatch.hosts_authorization = { exclude: ->(request) { true } }
              end
              
              # If above methods don't work, directly remove middleware
              Rails.application.config.middleware.delete(ActionDispatch::HostAuthorization) rescue nil
              EOF
              # Check if config file exists and if port is already specified
              if [ -f config/puma-streaming.rb ]; then
                # Use streaming-specific config file, don't repeat port specification
                bundle exec puma -C config/puma-streaming.rb -e production
              elif [ -f config/puma.rb ]; then
                # Check if config file already specifies port binding
                if grep -q "bind.*8080\|port.*8080" config/puma.rb 2>/dev/null; then
                  # Config file already specifies port, use directly
                  bundle exec puma -C config/puma.rb -e production
                else
                  # Config file doesn't specify port, use environment variable PORT
                  PORT=8080 bundle exec puma -C config/puma.rb -e production
                fi
              else
                # No config file, use environment variable PORT to specify port
                PORT=8080 bundle exec puma -e production
              fi
          env:
            - name: PUID
              value: "0"
            - name: PGID
              value: "0"
            - name: RAILS_ENV
              value: "production"
            - name: NODE_ENV
              value: "production"
            - name: PORT
              value: "8080"
            - name: BIND
              value: "0.0.0.0"
            # Allow Kubernetes internal IPs and health checks
            # Rails 8.0 Host Authorization requires explicitly allowed hosts
            - name: RAILS_HOST
              value: "0.0.0.0,localhost,127.0.0.1,mastodon-streaming"
            - name: RAILS_ALLOWED_HOSTS
              value: "0.0.0.0,localhost,127.0.0.1,mastodon-streaming,*.svc.cluster.local"
            - name: MASTODON_DATABASE_PASSWORD
              value: "{{ .Values.postgres.password }}"
            - name: DB_PASS
              value: "{{ .Values.postgres.password }}"
            - name: MASTODON_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mastodon-redis
                  key: "redis-password"
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mastodon-redis
                  key: "redis-password"
            {{- if .Values.storage.s3Enabled }}
            - name: MASTODON_AWS_ACCESS_KEY_ID
              value: "{{ .Values.minio.username }}"
            - name: MASTODON_AWS_SECRET_ACCESS_KEY
              value: "{{ .Values.minio.password }}"
            {{- end }}
          envFrom:
            - configMapRef:
                name: mastodon-default
            - secretRef:
                name: mastodon-default
          ports:
            - name: http
              containerPort: 8080
          livenessProbe:
            failureThreshold: 6
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
            httpGet:
              path: /api/v1/streaming/health
              port: http
              httpHeaders:
                - name: Host
                  value: mastodon-streaming
          readinessProbe:
            failureThreshold: 6
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
            httpGet:
              path: /api/v1/streaming/health
              port: http
              httpHeaders:
                - name: Host
                  value: mastodon-streaming
          volumeMounts:
            - name: empty-dir
              mountPath: /tmp
              subPath: tmp-dir
            - name: system-data
              mountPath: /app/www/public/system
      volumes:
          - name: empty-dir
            emptyDir: {}
          - name: system-data
            hostPath:
              {{- if .Values.sysVersion }}
                {{- if semverCompare ">=1.12.3-0" (toString .Values.sysVersion) }}
              path: '{{ .Values.userspace.appData }}/mastodon/system'
                {{- else }}
              path: '{{ .Values.userspace.appData }}/mastodon/mastodon/system'
                {{- end }}
              {{- else }}
              path: '{{ .Values.userspace.appData }}/mastodon/mastodon/system'
              {{- end }}
              type: DirectoryOrCreate
